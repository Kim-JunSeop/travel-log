<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{url_for('static', filename='css/index.css')}}">
    <link rel="stylesheet" href="{{url_for('static', filename='css/nav.css')}}">
    <script src="{{ url_for('static', filename='js/popup.js') }}"></script>
    <title>Travelog</title>
    <link rel="icon" href="{{url_for('static', filename='image/favicon (2).ico')}}">
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@10"></script>

    <!-- 만약 base.html하고 합치게 된다면, 아래 코드를 꼭 넣어야함(marker2에 대한 창 만들어주는 라이브러리 로드임) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="{{url_for('static', filename='css/bootstrap.4.5.0.min.css')}}">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>

</head>
<body>
<header id="header">
    <div class="inner">
        <h1><a href="/">Travelog</a></h1>
        <div class="gnb">
            {% if g.user %}
            <ul>
                <li><a href='/friends/find_friends'>친구찾기</a></li>
                <li><a href="/question/list">블로그</a></li>
                <li><a href="/input">나만의 지도</a></li>
                <li class="nav-item ">
                    <a class="nav-link" href="{{ url_for('main.logout') }}">{{ g.user.user_name }} 님 (로그아웃)</a>
                </li>
            </ul>
            {% else %}
            <ul>
                <li><a href='/friends/find_friends'>친구찾기</a></li>
                <li><a href="/question/list">블로그</a></li>
                <li><a href="/input">나만의 지도</a></li>
                <li><a href="/login">로그인</a></li>
                <li><a href=/signup>회원가입</a></li>
            </ul>
            {% endif %}
        </div>
    </div>
</header>
<div class="container">
    <h2 class="my-4">친구 찾기</h2>
    <div class="input-group mb-3">
        <input type="text" class="form-control" id="searchInput" placeholder="친구 검색" aria-label="친구 검색">
        <div class="input-group-append">
            <button class="btn btn-outline-secondary" type="button">검색</button>
        </div>
    </div>
    <div id="searchResults" class="row">
        <!-- 검색 결과가 여기에 동적으로 표시됩니다. -->
    </div>

    <!-- 나중에 알고리즘을 넣어서, 예를들어서 나랑 관심사 혹은 여행간 곳이 비슷한 사람을 우선배치 하는 알고리즘을 넣으면 재밌을것같음. -->
    <h3 class="my-4">친구 목록</h3>
    <ul class="list-group">
        {% for friend in users %} <!--사인업디비에있는 모든 유저에 대해서 하나하나 friend로 가져옴-->
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div class="friend-info">
                    {% if friend.profile_img %}
                        <img id="profileImg"
                             src="{{ url_for('static', filename='image/profile/' + friend.user_id + '/' + friend.profile_img if g.user.profile_img else 'image/User.png') }}"
                             style="border-radius: 50%; width: 130px; height: 130px;" />
                    {% else %}
                        <img data-url="/bz17854" class="usr_img" style="border-radius: 50%; width: 130px; height: 130px;" alt="작성자 프로필 이미지" src="{{ url_for('static', filename='image/User.png') }}">
                    {% endif %}
                    <span class="friend-name">{{ friend.user_name }}</span>
                    <span class="friend.user_id">{{ friend.user_id }}</span>
                    <span class="friend-phone">{{ friend.phone }}</span>
                </div>
                <div class="friend-actions"> <!--friends/follow엔드포인트로 주는 걸 .id인 인티저로 넘김12,11같이-->
                    <form action="{{ url_for('friends.follow', user_id=friend.id) }}" method="post" class="d-inline">
                        <input type="submit" value="팔로우" class="btn btn-primary">
                    </form>
                    {% if friend in g.user.friends %}
                    <form action="{{ url_for('friends.unfollow', user_id=friend.id) }}" method="post" class="d-inline">
                        <input type="submit" value="언팔로우" class="btn btn-danger">
                    </form>
                    {% endif %}
                </div>
            </li>
        {% endfor %}
    </ul>
</div>
{% block script %}
<style>
    .container {
        margin-top: 8%;
    }
</style>
<script>
    document.querySelector('.btn-outline-secondary').addEventListener('click', async () => {
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const searchQuery = searchInput.value.trim();

    if (searchQuery) {
        try {
            const response = await fetch(`/friends/search?search_query=${encodeURIComponent(searchQuery)}`);
            const results = await response.json();

            searchResults.innerHTML = '';

            results.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'col-12 col-md-6 col-lg-4 mb-3';
                userElement.innerHTML = `
                    <div class="card">
                     <img id="profileImg"
                             src="{{ url_for('static', filename='image/profile/' + friend.user_id + '/' + friend.profile_img if g.user.profile_img else 'image/User.png') }}"
                             style="border-radius: 50%; width: 130px; height: 130px;" />
                        <div class="card-body">
                            <h5 class="card-title">${user.user_name} (${user.user_id})</h5>
                            <p class="card-text">${user.phone}</p>
                            {% if g.user is not none %}
                            <form action="/friends/follow/${user.id}" method="post">
                                <input type="submit" value="팔로우" class="btn btn-primary">
                            </form>
                            {% if users.id in g.user.friend_ids %}
                            <form action="/friends/unfollow/${user.id}" method="post">
                                <input type="submit" value="언팔로우" class="btn btn-danger">
                            </form>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                `;

                searchResults.appendChild(userElement);
            });
        } catch (error) {
            console.error('Error fetching search results:', error);
        }
    }
});
</script>

</body>
</html>
{% endblock %}
